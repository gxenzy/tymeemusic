import fs from 'node:fs'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const srcDir = path.resolve(__dirname, '../src')
const registryPath = path.join(srcDir, 'registry.js')

function getFiles(dir) {
  const fullPath = path.join(srcDir, dir)
  if (!fs.existsSync(fullPath)) return []
  return fs
    .readdirSync(fullPath)
    .filter((f) => f.endsWith('.js') && f !== 'index.js')
}

const apis = getFiles('api')
const sources = getFiles('sources')
const lyrics = getFiles('lyrics')

const hasYouTube = fs.existsSync(
  path.join(srcDir, 'sources/youtube/YouTube.js')
)

let output = `// Auto-generated registry file
// Do not edit this file manually. It is regenerated during the build process.

`

apis.forEach((f, i) => (output += `import api_${i} from './api/${f}'\n`))
sources.forEach(
  (f, i) => (output += `import source_${i} from './sources/${f}'\n`)
)
if (hasYouTube) {
  output += "import source_yt from './sources/youtube/YouTube.js'\n"
}
lyrics.forEach((f, i) => (output += `import lyric_${i} from './lyrics/${f}'\n`))

output += '\nexport const apiRegistry = {\n'
apis.forEach((f, i) => (output += `  '${f}': api_${i},\n`))
output += '}\n\n'

output += 'export const sourceRegistry = {\n'
sources.forEach((f, i) => {
  const name = f.replace('.js', '')
  output += `  '${name}': source_${i},\n`
})
if (hasYouTube) {
  output += "  'youtube': source_yt,\n"
}
output += '}\n\n'

output += 'export const lyricRegistry = {\n'
lyrics.forEach((f, i) => {
  const name = f.replace('.js', '')
  output += `  '${name}': lyric_${i},\n`
})
output += '}\n'

fs.writeFileSync(registryPath, output)

console.log('Registry generated at src/registry.js')